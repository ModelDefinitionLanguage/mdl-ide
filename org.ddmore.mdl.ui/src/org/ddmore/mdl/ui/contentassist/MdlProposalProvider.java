/*
* generated by Xtext
*/
package org.ddmore.mdl.ui.contentassist;

import java.util.ArrayList;
import java.util.List;

import org.ddmore.mdl.domain.Attribute;
import org.ddmore.mdl.mdl.Argument;
import org.ddmore.mdl.mdl.DistributionArgument;
import org.ddmore.mdl.mdl.DistributionArguments;
import org.ddmore.mdl.mdl.DistributionEnum;
import org.ddmore.mdl.mdl.IndividualVarEnum;
import org.ddmore.mdl.mdl.InputFormatEnum;
import org.ddmore.mdl.mdl.PropertyDeclaration;
import org.ddmore.mdl.mdl.RandomList;
import org.ddmore.mdl.mdl.TargetEnum;
import org.ddmore.mdl.mdl.UseEnum;
import org.ddmore.mdl.mdl.VariabilityEnum;
import org.ddmore.mdl.mdl.impl.ArgumentImpl;
import org.ddmore.mdl.mdl.impl.DiagBlockImpl;
import org.ddmore.mdl.mdl.impl.DistributionArgumentImpl;
import org.ddmore.mdl.mdl.impl.IndividualVariablesBlockImpl;
import org.ddmore.mdl.mdl.impl.ListImpl;
import org.ddmore.mdl.mdl.impl.MatrixBlockImpl;
import org.ddmore.mdl.mdl.impl.MclObjectImpl;
import org.ddmore.mdl.mdl.impl.PropertyDeclarationImpl;
import org.ddmore.mdl.mdl.impl.RandomListImpl;
import org.ddmore.mdl.mdl.impl.SameBlockImpl;
import org.ddmore.mdl.mdl.impl.VariabilityBlockImpl;
import org.ddmore.mdl.services.MdlGrammarAccess;
import org.ddmore.mdl.types.VariableType;
import org.ddmore.mdl.ui.contentassist.AbstractMdlProposalProvider;
import org.ddmore.mdl.ui.outline.Images;
import org.ddmore.mdl.validation.AttributeValidator;
import org.ddmore.mdl.validation.DistributionValidator;
import org.ddmore.mdl.validation.PropertyValidator;
import org.ddmore.mdl.validation.UnitValidator;
import org.ddmore.mdl.validation.Utils;
import org.eclipse.emf.ecore.EObject;
import org.eclipse.jface.viewers.StyledString;
import org.eclipse.swt.graphics.Image;
import org.eclipse.xtext.Assignment;
import org.eclipse.xtext.ui.IImageHelper;
import org.eclipse.xtext.ui.editor.contentassist.ConfigurableCompletionProposal;
import org.eclipse.xtext.ui.editor.contentassist.ContentAssistContext;
import org.eclipse.xtext.ui.editor.contentassist.ICompletionProposalAcceptor;

import com.google.inject.Inject;
/**
 * see http://www.eclipse.org/Xtext/documentation/latest/xtext.html#contentAssist on how to customize content assistant
 */

public class MdlProposalProvider extends AbstractMdlProposalProvider {
		
	@Inject MdlGrammarAccess grammarAccess;
	@Inject IImageHelper imageHelper;
	
	@Override
	public void completeList_Arguments(EObject model, Assignment assignment, ContentAssistContext context, ICompletionProposalAcceptor acceptor) {
	}

	@Override
	public void completeRandomList_Arguments(EObject model, Assignment assignment, ContentAssistContext context, ICompletionProposalAcceptor acceptor) {
	}
	
	@Override
	public void completeArguments_Arguments(EObject model, Assignment assignment, ContentAssistContext context, ICompletionProposalAcceptor acceptor) {
	}

	@Override
	public void completeArgument_ArgumentName(EObject model, Assignment assignment, ContentAssistContext context, ICompletionProposalAcceptor acceptor) {
		if (model instanceof ListImpl){
			EObject container = model.eContainer();
			while (!(Utils.isListContainer(container))){
				if (container instanceof MclObjectImpl) return; //we are too high in the tree, block was not found
				container = container.eContainer();
			}
			Image img = imageHelper.getImage(Images.getPath(Images.ATTRIBUTE));
			List<String> attributes = Utils.getAllNames(AttributeValidator.getAllAttributes(container));
			addProposals(context, acceptor, attributes, img);
		}
	}
	
	@Override
	public void completeArgument_Expression(EObject model, Assignment assignment, ContentAssistContext context, ICompletionProposalAcceptor acceptor) {
		if (model instanceof ArgumentImpl){
			Argument arg = (Argument)model;
			//target
			if (arg.getArgumentName().getName().equals(AttributeValidator.attr_req_target.getName())){
				List<String> attributes = new ArrayList<String>();
				for (TargetEnum value: TargetEnum.VALUES)
					attributes.add(value.toString());
				Image img = imageHelper.getImage(Images.getPath(Images.TARGET_LANGUAGE));				
				addProposals(context, acceptor, attributes, img); return;
			}	
			//use
			if (arg.getArgumentName().getName().equals(AttributeValidator.attr_use.getName())){
				List<String> attributes = new ArrayList<String>();
				for (UseEnum value: UseEnum.VALUES)
					attributes.add(value.toString());
				Image img = imageHelper.getImage(Images.getPath(Images.USE_TYPE));				
				addProposals(context, acceptor, attributes, img); return;
			}		
			//type
			if (arg.getArgumentName().getName().equals(AttributeValidator.attr_req_cc_type.getName())){
				EObject container = Utils.findListContainer(arg);
				List<String> attributes = new ArrayList<String>();
				if (container instanceof VariabilityBlockImpl || container instanceof MatrixBlockImpl || 
					container instanceof DiagBlockImpl || container instanceof SameBlockImpl){
					for (VariabilityEnum value: VariabilityEnum.VALUES)
						attributes.add(value.toString());
					Image img = imageHelper.getImage(Images.getPath(Images.VARIABILITY_TYPE));				
					addProposals(context, acceptor, attributes, img); return;
				}
				if (container instanceof IndividualVariablesBlockImpl){
					for (IndividualVarEnum value: IndividualVarEnum.VALUES)
						attributes.add(value.toString());
					Image img = imageHelper.getImage(Images.getPath(Images.VARIABILITY_TYPE));				
					addProposals(context, acceptor, attributes, img); 
				} else {
						attributes.addAll(VariableType.CC_VALUES);
						Image img = imageHelper.getImage(Images.getPath(Images.CC_TYPE));				
						addProposals(context, acceptor, attributes, img);
				}
			}
			//units
			if (arg.getArgumentName().getName().equals(AttributeValidator.attr_units.getName())){
				List<String> attributes = new ArrayList<String>();
				attributes.addAll(UnitValidator.getUnitNames());
				Image img = imageHelper.getImage(Images.getPath(Images.EXPRESSION));				
				addProposals(context, acceptor, attributes, img);
			}
		}
	}
	
	
	@Override
	public void completePropertyDeclaration_Expression(EObject model, Assignment assignment, ContentAssistContext context, ICompletionProposalAcceptor acceptor){
		if (model instanceof PropertyDeclarationImpl){
			PropertyDeclaration property = (PropertyDeclaration)model;
			//inputformat
			if (property.getPropertyName().getName().equals(PropertyValidator.attr_inputformat.getName())){
				List<String> values = new ArrayList<String>();
				for (InputFormatEnum value: InputFormatEnum.VALUES)
					values.add(value.toString());
				Image img = imageHelper.getImage(Images.getPath(Images.TARGET_LANGUAGE));				
				addProposals(context, acceptor, values, img);
			}
		}
	} 
	
	@Override
	public void completeDistributionArguments_Arguments(EObject model, Assignment assignment, ContentAssistContext context, ICompletionProposalAcceptor acceptor) {
		//Distribution attributes
		if (model instanceof RandomListImpl){
			RandomList randomList = (RandomList)model;
			DistributionArguments args = randomList.getArguments();
			DistributionArgument type = DistributionValidator.findDistributionAttribute(args, 
				DistributionValidator.attr_type.getName());
			Image img = imageHelper.getImage(Images.getPath(Images.DISTRIBUTION_ATTRIBUTE));
			if (type != null){
				String typeName = type.getDistribution().toString();
				List<Attribute> recognized_attrs = DistributionValidator.distr_attrs.get(typeName);
				if (recognized_attrs != null){
					List<String> attributes = Utils.getAllNames(recognized_attrs);
					addProposals(context, acceptor, attributes, img);
				}
			} else {
				//suggest attribute type
				List<String> attributes = new ArrayList<String>();
				attributes.add(DistributionValidator.attr_type.getName());
				addProposals(context, acceptor, attributes, img);
			}
		}
	}
		
	@Override
	public void completeDistributionArgument_Distribution(EObject model, Assignment assignment, ContentAssistContext context, ICompletionProposalAcceptor acceptor) {
		if (model instanceof DistributionArgumentImpl){
			DistributionArgument arg = (DistributionArgument)model;
			if (arg.getArgumentName().getName().equals(DistributionValidator.attr_type.getName())){
				List<String> attributes = new ArrayList<String>();
				for (DistributionEnum value: DistributionEnum.VALUES)
					attributes.add(value.toString()); 
				Image img = imageHelper.getImage(Images.getPath(Images.DISTRIBUTION_TYPE));
				addProposals(context, acceptor, attributes, img);
			}
		}
	}

	@Override
	public void completeDistributionArgument_Expression(EObject model, Assignment assignment, ContentAssistContext context, ICompletionProposalAcceptor acceptor) {
	}

	@Override
	public void completeDistributionArgument_Component(EObject model, Assignment assignment, ContentAssistContext context, ICompletionProposalAcceptor acceptor) {
	}
	
	private void addProposals(ContentAssistContext context, ICompletionProposalAcceptor acceptor, 
			List<String> attributes, Image img){
		for (String proposal: attributes){
			StyledString displayedString = new StyledString();
			displayedString.append(proposal);
			ConfigurableCompletionProposal p = doCreateProposal(proposal, displayedString, img, 1, context);
			acceptor.accept(p);
		}
	}
}
